create table if not exists databasechangelog
(
    id            varchar(255) not null,
    author        varchar(255) not null,
    filename      varchar(255) not null,
    dateexecuted  timestamp    not null,
    orderexecuted integer      not null,
    exectype      varchar(10)  not null,
    md5sum        varchar(35),
    description   varchar(255),
    comments      varchar(255),
    tag           varchar(255),
    liquibase     varchar(20),
    contexts      varchar(255),
    labels        varchar(255),
    deployment_id varchar(10)
);

create table if not exists databasechangeloglock
(
    id          integer not null,
    locked      boolean not null,
    lockgranted timestamp,
    lockedby    varchar(255),
    constraint databasechangeloglock_pkey
        primary key (id)
);

create table if not exists categories
(
    id            integer generated by default as identity,
    category_name varchar(255),
    constraint categories_pkey
        primary key (id)
);

create table if not exists customers
(
    id                 integer generated by default as identity,
    created_by         integer not null,
    created_date       timestamp(6),
    last_modified_by   integer,
    last_modified_date timestamp(6),
    address            varchar(255),
    customer_name      varchar(255),
    gender             boolean,
    is_active          boolean,
    phone              varchar(255),
    total_spent        bigint,
    constraint customers_pkey
        primary key (id),
    constraint ukm3iom37efaxd5eucmxjqqcbe9
        unique (phone)
);

create table if not exists product_attributes
(
    id             integer generated by default as identity,
    attribute_name varchar(255),
    constraint product_attributes_pkey
        primary key (id)
);

create table if not exists products
(
    id                 integer generated by default as identity,
    created_by         integer not null,
    created_date       timestamp(6),
    last_modified_by   integer,
    last_modified_date timestamp(6),
    description        varchar(255),
    product_name       varchar(255),
    status             varchar(255),
    fts                tsvector,
    constraint products_pkey
        primary key (id)
);

create table if not exists product_categories
(
    category_id integer,
    product_id  integer,
    constraint fkd112rx0alycddsms029iifrih
        foreign key (category_id) references categories,
    constraint fklda9rad6s180ha3dl1ncsp8n7
        foreign key (product_id) references products
);

create index if not exists idx_product_name_trgm
    on products using gin (product_name gin_trgm_ops);

create index if not exists idx_product_desc_trgm
    on products using gin (description gin_trgm_ops);

create index if not exists idx_products_fts
    on products using gin (fts);

create trigger trg_products_fts
    before insert or update
    on products
    for each row
execute procedure products_fts_trigger();

create table if not exists units
(
    id        integer generated by default as identity,
    unit_name varchar(255) not null,
    constraint units_pkey
        primary key (id),
    constraint uk525csmemmgtoicjcfhcpf3pk0
        unique (unit_name)
);

create table if not exists product_variants
(
    id                 integer generated by default as identity,
    created_by         integer not null,
    created_date       timestamp(6),
    last_modified_by   integer,
    last_modified_date timestamp(6),
    barcode            varchar(255),
    cost_price         bigint,
    expiry_date        timestamp(6),
    price              bigint,
    product_id         integer,
    quantity           integer,
    sku                varchar(255),
    unit_id            integer,
    status             varchar(255),
    fts                tsvector,
    constraint product_variants_pkey
        primary key (id),
    constraint product_variants_unit_id_fkey
        foreign key (unit_id) references units,
    constraint product_variants_product_id_fkey
        foreign key (product_id) references products
);

create table if not exists product_attribute_values
(
    id                 integer generated by default as identity,
    created_by         integer not null,
    created_date       timestamp(6),
    last_modified_by   integer,
    last_modified_date timestamp(6),
    attr_id            integer,
    attr_value         varchar(255),
    product_variant_id integer,
    unit_id            integer,
    constraint product_attribute_values_pkey
        primary key (id),
    constraint product_attribute_values_product_variant_id_fkey
        foreign key (product_variant_id) references product_variants,
    constraint product_attribute_values_attr_id_fkey
        foreign key (attr_id) references product_attributes
);

create table if not exists product_images
(
    id                 integer generated by default as identity,
    path               varchar(255),
    product_variant_id integer,
    constraint product_images_pkey
        primary key (id),
    constraint product_images_product_variant_id_fkey
        foreign key (product_variant_id) references product_variants
);

create index if not exists idx_variant_sku_trgm
    on product_variants using gin (sku gin_trgm_ops);

create index if not exists idx_variant_barcode_trgm
    on product_variants using gin (barcode gin_trgm_ops);

create index if not exists idx_product_variants_fts
    on product_variants using gin (fts);

create trigger trg_product_variants_fts
    before insert or update
    on product_variants
    for each row
execute procedure product_variants_fts_trigger();

create table if not exists users
(
    id                 integer generated by default as identity,
    created_by         integer not null,
    created_date       timestamp(6),
    last_modified_by   integer,
    last_modified_date timestamp(6),
    email              varchar(255),
    fullname           varchar(255),
    gender             boolean,
    is_active          boolean,
    password           varchar(255),
    phone              varchar(255),
    role               varchar(255),
    username           varchar(255),
    constraint users_pkey
        primary key (id),
    constraint uk6dotkott2kjsp8vw4d0m25fb7
        unique (email),
    constraint ukdu5v5sr43g5bfnji4vb8hg5s3
        unique (phone)
);

create table if not exists notifications
(
    id          integer generated by default as identity,
    body        varchar(255),
    is_read     boolean,
    title       varchar(255),
    user_id     integer,
    date        timestamp(6),
    entity_id   integer,
    entity_type varchar(255),
    type        varchar(255),
    constraint notifications_pkey
        primary key (id),
    constraint notifications_user_id_fkey
        foreign key (user_id) references users
);

create table if not exists orders
(
    id                 integer generated by default as identity,
    created_by         integer not null,
    created_date       timestamp(6),
    last_modified_by   integer,
    last_modified_date timestamp(6),
    customer_id        integer,
    note               varchar(255),
    order_date         timestamp(6),
    order_status       varchar(255),
    receiver_address   varchar(255),
    receiver_name      varchar(255),
    receiver_phone     varchar(255),
    total_amount       bigint,
    user_id            integer,
    constraint orders_pkey
        primary key (id),
    constraint orders_user_id_fkey
        foreign key (user_id) references users
);

create table if not exists order_details
(
    order_id           integer not null,
    product_variant_id integer,
    sold_price         bigint,
    sold_quantity      integer,
    price              bigint,
    constraint fkjyu2qbqt8gnvno9oe9j2s2ldk
        foreign key (order_id) references orders,
    constraint fksx0enyl805emarbr0bgoln1oq
        foreign key (product_variant_id) references product_variants
);

create table if not exists order_histories
(
    id                 integer generated by default as identity,
    created_by         integer not null,
    created_date       timestamp(6),
    last_modified_by   integer,
    last_modified_date timestamp(6),
    new_status         varchar(255),
    old_status         varchar(255),
    order_id           integer,
    constraint order_histories_pkey
        primary key (id),
    constraint order_histories_order_id_fkey
        foreign key (order_id) references orders
);

create table if not exists payments
(
    id                 integer generated by default as identity,
    created_by         integer not null,
    created_date       timestamp(6),
    last_modified_by   integer,
    last_modified_date timestamp(6),
    date               timestamp(6),
    order_id           integer,
    paid               bigint,
    payment_method     varchar(255),
    remaining          bigint,
    status             varchar(255),
    constraint payments_pkey
        primary key (id),
    constraint payments_order_id_fkey
        foreign key (order_id) references orders
);

